# Схема формирования реферальной таблицы

## Процесс раскрытия узлов

```
┌─────────────────────────────────────────────────────────────────┐
│                    ИНИЦИАЛИЗАЦИЯ                                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Загрузка данных из API /api/referrals/tree                  │
│ 2. Преобразование дерева в плоский список (flattenTree)        │
│ 3. Рендеринг корневых элементов (renderTable)                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    НАЧАЛЬНОЕ СОСТОЯНИЕ                          │
└─────────────────────────────────────────────────────────────────┘

Таблица содержит только корневые элементы:
┌─────────────────────────────────────────────────────────────────┐
│ Структура │ Дата      │ ID реферала │ ID пригласителя │ Никнейм │
├─────────────────────────────────────────────────────────────────┤
│ [+] 12    │ 01.09.2025│ user001     │ root001         │ john_doe│
│ [+] 8     │ 02.09.2025│ user002     │ root001         │ jane_sm │
│ [+] 5     │ 03.09.2025│ user003     │ root002         │ bob_wil │
└─────────────────────────────────────────────────────────────────┘

                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    КЛИК ПО КНОПКЕ [+]                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    toggleNode(nodeId)                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Проверка: expandedNodes.has(nodeId)                         │
│ 2. Добавление: expandedNodes.add(nodeId)                       │
│ 3. Изменение кнопки: [+] → [−]                                 │
│ 4. Вызов: showDirectChildren(nodeId, parentRow)                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                showDirectChildren(parentId, parentRow)          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Поиск родителя: referralData.find(item => item.referal_id)  │
│ 2. Получение детей: parent.children                            │
│ 3. Для каждого ребенка:                                        │
│    - createTableRow(child)                                     │
│    - Вставка в DOM после родителя                              │
│    - Проверка: expandedNodes.has(child.referal_id)             │
│    - Рекурсивный вызов showDirectChildren если раскрыт          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    РЕЗУЛЬТАТ РАСКРЫТИЯ                          │
└─────────────────────────────────────────────────────────────────┘

Таблица после раскрытия узла user001:
┌─────────────────────────────────────────────────────────────────┐
│ Структура │ Дата      │ ID реферала │ ID пригласителя │ Никнейм │
├─────────────────────────────────────────────────────────────────┤
│ [−] 12    │ 01.09.2025│ user001     │ root001         │ john_doe│
│   [+] 4   │ 20.01.2025│ user004     │ user001         │ alice_br│
│   [+] 4   │ 21.01.2025│ user005     │ user001         │ charlie │
│ [+] 8     │ 02.09.2025│ user002     │ root001         │ jane_sm │
│ [+] 5     │ 03.09.2025│ user003     │ root002         │ bob_wil │
└─────────────────────────────────────────────────────────────────┘

                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                updateTreeLines() - Обновление линий             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Удаление всех существующих линий                            │
│ 2. Для каждой строки:                                          │
│    - Добавление горизонтальной линии (если level > 0)          │
│    - Добавление вертикальной линии (если узел раскрыт)         │
│ 3. Позиционирование линий относительно кнопок                  │
└─────────────────────────────────────────────────────────────────┘
```

## Процесс скрытия узлов

```
┌─────────────────────────────────────────────────────────────────┐
│                    КЛИК ПО КНОПКЕ [−]                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    toggleNode(nodeId)                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Проверка: expandedNodes.has(nodeId)                         │
│ 2. Удаление: expandedNodes.delete(nodeId)                      │
│ 3. Изменение кнопки: [−] → [+]                                 │
│ 4. Вызов: hideDirectChildren(nodeId)                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                hideDirectChildren(parentId)                     │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Поиск дочерних строк: tr[data-parent="${parentId}"]         │
│ 2. Для каждой дочерней строки:                                 │
│    - Удаление из DOM: row.remove()                             │
│    - Рекурсивное скрытие: hideAllDescendants(childId)          │
│    - Удаление из состояния: expandedNodes.delete(childId)      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                hideAllDescendants(ancestorId)                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Поиск всех потомков в DOM                                   │
│ 2. Проверка: isDescendantOf(rowData, ancestorId)               │
│ 3. Удаление потомков: row.remove()                             │
│ 4. Очистка состояния: expandedNodes.delete(rowId)              │
└─────────────────────────────────────────────────────────────────┘
```

## Структура данных

```
┌─────────────────────────────────────────────────────────────────┐
│                    referralData (плоский список)                │
└─────────────────────────────────────────────────────────────────┘

[
  {
    referal_id: "user001",
    referer_id: "root001", 
    level: 0,
    totalReferals: 12,
    children: [
      {
        referal_id: "user004",
        referer_id: "user001",
        level: 1,
        totalReferals: 4,
        children: [...]
      },
      {
        referal_id: "user005", 
        referer_id: "user001",
        level: 1,
        totalReferals: 4,
        children: [...]
      }
    ]
  }
]

┌─────────────────────────────────────────────────────────────────┐
│                    expandedNodes (Set)                          │
└─────────────────────────────────────────────────────────────────┘

Set {
  "user001",  // Раскрыт
  "user004",  // Раскрыт
  // "user005" - свернут
}
```

## Атрибуты DOM элементов

```
┌─────────────────────────────────────────────────────────────────┐
│                    Строка таблицы (tr)                          │
└─────────────────────────────────────────────────────────────────┘

<tr class="table-row" 
    data-id="user004"           // ID реферала
    data-level="1"              // Уровень вложенности  
    data-parent="user001"       // ID родителя
    data-has-children="true">   // Есть ли дети
    
  <td class="tree-cell level-1">  // Ячейка с деревом
    <div class="tree-content">
      <button class="tree-toggle expanded"  // Кнопка [+]/[−]
              onclick="toggleNode('user004')">
      </button>
      <span class="status-indicator status-active"></span>  // Индикатор
      4  // Количество рефералов в структуре
    </div>
  </td>
  
  <td>20.01.2025</td>           // Дата регистрации
  <td>user004</td>              // ID реферала
  <td>user001</td>              // ID пригласителя  
  <td>alice_brown</td>          // Никнейм реферала
  <td>john_doe</td>             // Никнейм пригласителя
</tr>
```

## Соединительные линии

```
┌─────────────────────────────────────────────────────────────────┐
│                    Горизонтальные линии                         │
└─────────────────────────────────────────────────────────────────┘

Каждая дочерняя строка (level > 0) получает горизонтальную линию:
- Позиция: left: 9px, 34px, 59px (в зависимости от уровня)
- Стиль: круглая точка (border-radius: 50%)
- Цвет: #cbd5e1

┌─────────────────────────────────────────────────────────────────┐
│                    Вертикальные линии                           │
└─────────────────────────────────────────────────────────────────┘

Раскрытые узлы получают вертикальную линию:
- Начало: центр кнопки родителя
- Конец: середина последней дочерней строки
- Позиция: left: 13 + (parentLevel * 25)px
- Стиль: вертикальная полоса (width: 2px)
- Цвет: #cbd5e1
```
