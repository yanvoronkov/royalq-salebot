# Исправление дубликатов рефералов

## Проблема
В системе были обнаружены дубликаты рефералов с одинаковыми `referal_id`, что нарушает целостность данных и может привести к ошибкам в работе системы.

## Решение

### 1. Улучшенная защита от дублирования

#### В сервисе рефералов (`src/services/referal.service.js`):
- ✅ Добавлена предварительная проверка существования реферала
- ✅ Улучшена обработка ошибок дублирования MongoDB (код 11000)
- ✅ Добавлен новый метод `createOrUpdateReferal()` для безопасного upsert

#### В обработчике ошибок (`src/utils/error-handler.js`):
- ✅ Добавлена специальная обработка ошибок дублирования
- ✅ Информативные сообщения об ошибках
- ✅ Правильные HTTP коды ответов (409 Conflict)

#### В контроллере (`src/controllers/referal.controller.js`):
- ✅ Добавлен новый метод `createOrUpdateReferal()`

#### В маршрутах (`src/routes/referal.routes.js`):
- ✅ Добавлен новый endpoint `POST /api/referals/upsert` для безопасного создания/обновления

### 2. Скрипты для работы с дубликатами

#### `scripts/clean-duplicates.js`
Скрипт для очистки существующих дубликатов:
- Находит все дубликаты по `referal_id`
- Оставляет самый старый документ (по `createdAt`)
- Удаляет остальные дубликаты
- Показывает подробную статистику

#### `scripts/check-unique-indexes.js`
Скрипт для проверки и создания уникальных индексов:
- Проверяет существование уникальных индексов
- Создает недостающие индексы
- Проверяет дубликаты в данных
- Показывает подробную информацию об индексах

### 3. Команды Makefile

```bash
# Проверить дубликаты и индексы
make check-duplicates

# Очистить дубликаты (с подтверждением)
make clean-duplicates

# Проверить только индексы
make check-indexes
```

## Пошаговая инструкция по исправлению

### Шаг 1: Проверка текущего состояния
```bash
make check-duplicates
```

### Шаг 2: Создание бэкапа (рекомендуется)
```bash
make backup
```

### Шаг 3: Очистка дубликатов
```bash
make clean-duplicates
```

### Шаг 4: Проверка результата
```bash
make check-duplicates
```

## API Endpoints

### Строгое создание (с проверкой дублирования)
```http
POST /api/referals
Content-Type: application/json

{
  "referal_id": "user123",
  "referer_id": "root001",
  "referal_nickname": "john_doe",
  "referal_name": "John Doe"
}
```

**Ответ при дублировании:**
```json
{
  "error": {
    "message": "Referal with ID \"user123\" already exists",
    "code": "DUPLICATE_REFERAL"
  }
}
```

### Безопасное создание/обновление (upsert)
```http
POST /api/referals/upsert
Content-Type: application/json

{
  "referal_id": "user123",
  "referer_id": "root001",
  "referal_nickname": "john_doe_updated",
  "referal_name": "John Doe Updated"
}
```

**Ответ:**
```json
{
  "message": "Referal created or updated successfully",
  "data": {
    "referal_id": "user123",
    "referer_id": "root001",
    "referal_nickname": "john_doe_updated",
    "referal_name": "John Doe Updated",
    "_id": "...",
    "createdAt": "...",
    "updatedAt": "..."
  }
}
```

## Рекомендации по использованию

1. **Для новых интеграций** используйте `POST /api/referals/upsert` - это безопасно и не вызовет ошибок при дублировании
2. **Для строгого контроля** используйте `POST /api/referals` - будет возвращать ошибку при попытке создать дубликат
3. **Регулярно проверяйте** дубликаты командой `make check-duplicates`
4. **Создавайте бэкапы** перед очисткой дубликатов

## Мониторинг

После исправления рекомендуется:
1. Настроить мониторинг ошибок дублирования в логах
2. Регулярно проверять целостность данных
3. Использовать upsert endpoint для всех внешних интеграций

## Технические детали

### Уникальные индексы
- `referals.referal_id` - уникальный индекс
- `payments.transactionId` - уникальный sparse индекс

### Обработка ошибок
- Код 11000 (MongoDB duplicate key) → HTTP 409 Conflict
- Кастомные ошибки дублирования → HTTP 409 Conflict
- Валидационные ошибки → HTTP 400 Bad Request

### Безопасность
- Все операции с дубликатами требуют подтверждения
- Автоматическое создание бэкапов перед критическими операциями
- Подробное логирование всех операций
