<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Реферальная таблица - <%- referal.referal_nickname %></title>
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/table-style.css">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
	<div class="dashboard-wrapper">
		<!-- Header Section -->
		<header class="dashboard-header">
			<div class="header-content">
				<div class="user-info">
					<div class="avatar">
						<i class="fas fa-user"></i>
					</div>
					<div class="user-details">
						<h1><%- referal.referal_name %></h1>
						<p class="user-id">@<%- referal.referal_nickname %> • ID: <%- referal.referal_id %></p>
						<p class="join-date">Присоединился: <%- new Date(referal.reg_date).toLocaleDateString('ru-RU')
								%></p>
					</div>
				</div>
				<div class="header-actions">
					<div class="view-switcher">
						<button class="btn btn-outline active" onclick="switchToTree()">
							<i class="fas fa-sitemap"></i>
							Дерево
						</button>
						<button class="btn btn-primary" onclick="switchToTable()">
							<i class="fas fa-table"></i>
							Таблица
						</button>
					</div>
					<button class="btn btn-secondary" onclick="copyReferralLink()">
						<i class="fas fa-link"></i>
						Копировать ссылку
					</button>
					<button class="btn btn-secondary" onclick="exportData()">
						<i class="fas fa-download"></i>
						Экспорт
					</button>
				</div>
			</div>
		</header>

		<!-- Stats Section -->
		<section class="stats-section">
			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-icon">
						<i class="fas fa-users"></i>
					</div>
					<div class="stat-content">
						<h3 id="totalReferrals">0</h3>
						<p>Всего рефералов</p>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon">
						<i class="fas fa-layer-group"></i>
					</div>
					<div class="stat-content">
						<h3 id="maxLevel">0</h3>
						<p>Макс. глубина</p>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon">
						<i class="fas fa-chart-line"></i>
					</div>
					<div class="stat-content">
						<h3 id="activeLevels">0</h3>
						<p>Активных уровней</p>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon">
						<i class="fas fa-calendar-day"></i>
					</div>
					<div class="stat-content">
						<h3 id="todayReferrals">0</h3>
						<p>Сегодня</p>
					</div>
				</div>
			</div>
		</section>

		<!-- Controls Section -->
		<section class="controls-section">
			<div class="controls-left">
				<div class="search-container">
					<i class="fas fa-search search-icon"></i>
					<input type="text" id="searchInput" placeholder="Поиск по всем полям...">
					<button class="clear-search" id="clearSearch" style="display: none;">
						<i class="fas fa-times"></i>
					</button>
				</div>
			</div>
			<div class="controls-right">
				<div class="view-controls">
					<button class="btn btn-outline" id="expandAll">
						<i class="fas fa-expand-arrows-alt"></i>
						Развернуть все
					</button>
					<button class="btn btn-outline" id="collapseAll">
						<i class="fas fa-compress-arrows-alt"></i>
						Свернуть все
					</button>
				</div>
				<div class="level-filter">
					<label for="levelFilter">Показать уровни:</label>
					<select id="levelFilter">
						<option value="all">Все уровни</option>
						<option value="1">Только 1-й уровень</option>
						<option value="2">До 2-го уровня</option>
						<option value="3">До 3-го уровня</option>
						<option value="4">До 4-го уровня</option>
						<option value="5">До 5-го уровня</option>
						<option value="6">До 6-го уровня</option>
						<option value="7">До 7-го уровня</option>
						<option value="8">До 8-го уровня</option>
						<option value="9">До 9-го уровня</option>
						<option value="10">До 10-го уровня</option>
					</select>
				</div>
			</div>
		</section>

		<!-- Table Section -->
		<section class="table-section">
			<% if (referalTree && referalTree.length> 0) { %>
				<div class="table-container">
					<div class="table-header">
						<h2>Реферальная таблица</h2>
						<div class="table-info">
							<span class="table-stats">
								<i class="fas fa-table"></i>
								<span id="tableStats">Загрузка...</span>
							</span>
						</div>
					</div>

					<div class="table-wrapper">
						<table class="referral-table" id="referralTable">
							<thead>
								<tr>
									<th class="level-col">Уровень</th>
									<th class="tree-col">Дерево</th>
									<th class="id-col">ID</th>
									<th class="nickname-col">Никнейм</th>
									<th class="name-col">Имя</th>
									<th class="date-col">Дата регистрации</th>
									<th class="referer-col">Пригласил</th>
									<th class="link-col">Реферальная ссылка</th>
									<th class="channel-col">Канал</th>
									<th class="utm-col">UTM</th>
									<th class="actions-col">Действия</th>
								</tr>
							</thead>
							<tbody>
								<% function countTotalReferrals(node) { let count=(node.children &&
									node.children.length) || 0; if (node.children) { node.children.forEach(child=> {
									count += countTotalReferrals(child);
									});
									}
									return count;
									} %>

									<% function displayReferralTable(tree, level, parentReferalId, isLast=false) {
										tree.forEach((referal, index)=> {
										const totalReferrals = countTotalReferrals(referal);
										const hasChildren = referal.children && referal.children.length > 0;
										const isLastInGroup = index === tree.length - 1;
										%>
										<tr class="referral-row level-<%= level %>"
											data-referal-id="<%- referal.referal_id %>"
											data-referer-id="<%- referal.referer_id || parentReferalId %>"
											data-level="<%- level %>" data-has-children="<%= hasChildren %>">

											<!-- Уровень -->
											<td class="level-cell">
												<div class="level-indicator level-<%= level %>">
													<span class="level-number">
														<%= level %>
													</span>
												</div>
											</td>

											<!-- Дерево с соединительными линиями -->
											<td class="tree-cell">
												<div class="tree-structure">
													<div class="tree-lines">
														<% if (level> 1) { %>
															<!-- Вертикальная линия от родителя -->
															<div class="vertical-line"></div>
															<!-- Горизонтальная линия к узлу -->
															<div
																class="horizontal-line <%= isLastInGroup ? 'last' : '' %>">
															</div>
															<% } %>
													</div>
													<div class="tree-controls">
														<% if (hasChildren) { %>
															<button class="toggle-btn"
																data-target="<%- referal.referal_id %>">
																<i class="fas fa-chevron-right"></i>
															</button>
															<span class="children-count">
																<%= totalReferrals %>
															</span>
															<% } else { %>
																<div class="no-children">
																	<i class="fas fa-circle"></i>
																</div>
																<% } %>
													</div>
												</div>
											</td>

											<!-- ID -->
											<td class="id-cell">
												<div class="cell-content">
													<span class="referral-id"><%- referal.referal_id %></span>
												</div>
											</td>

											<!-- Никнейм -->
											<td class="nickname-cell">
												<div class="cell-content">
													<span class="nickname">@<%- referal.referal_nickname %></span>
												</div>
											</td>

											<!-- Имя -->
											<td class="name-cell">
												<div class="cell-content">
													<span class="name"><%- referal.referal_name %></span>
												</div>
											</td>

											<!-- Дата регистрации -->
											<td class="date-cell">
												<div class="cell-content">
													<span class="date">
														<i class="fas fa-calendar"></i>
														<%- new Date(referal.reg_date).toLocaleDateString('ru-RU') %>
													</span>
												</div>
											</td>

											<!-- Пригласил -->
											<td class="referer-cell">
												<div class="cell-content">
													<% if (referal.referer_id) { %>
														<span class="referer">
															<i class="fas fa-user-plus"></i>
															<%- referal.referer_id %>
														</span>
														<% } else { %>
															<span class="no-referer">Корневой пользователь</span>
															<% } %>
												</div>
											</td>

											<!-- Реферальная ссылка -->
											<td class="link-cell">
												<div class="cell-content">
													<div class="link-container">
														<span class="link-text"
															title="<%- referal.referral_link_url %>">
															<%- referal.referral_link_url.length> 30 ?
																referal.referral_link_url.substring(0, 30) + '...' :
																referal.referral_link_url %>
														</span>
														<button class="copy-btn"
															onclick="copyToClipboard('<%- referal.referral_link_url %>')"
															title="Копировать ссылку">
															<i class="fas fa-copy"></i>
														</button>
													</div>
												</div>
											</td>

											<!-- Канал -->
											<td class="channel-cell">
												<div class="cell-content">
													<% if (referal.personal_channel_link) { %>
														<a href="<%- referal.personal_channel_link %>" target="_blank"
															class="channel-link">
															<i class="fab fa-telegram"></i>
															<span>Канал</span>
														</a>
														<% } else { %>
															<span class="no-channel">—</span>
															<% } %>
												</div>
											</td>

											<!-- UTM -->
											<td class="utm-cell">
												<div class="cell-content">
													<span class="utm" title="<%- referal.utm %>">
														<%- referal.utm.length> 20 ?
															referal.utm.substring(0, 20) + '...' :
															referal.utm %>
													</span>
												</div>
											</td>

											<!-- Действия -->
											<td class="actions-cell">
												<div class="cell-content">
													<div class="action-buttons">
														<button class="action-btn"
															onclick="viewDetails('<%- referal.referal_id %>')"
															title="Подробности">
															<i class="fas fa-info-circle"></i>
														</button>
														<button class="action-btn"
															onclick="copyToClipboard('<%- referal.referral_link_url %>')"
															title="Копировать ссылку">
															<i class="fas fa-link"></i>
														</button>
														<% if (referal.personal_channel_link) { %>
															<a href="<%- referal.personal_channel_link %>"
																target="_blank" class="action-btn"
																title="Открыть канал">
																<i class="fab fa-telegram"></i>
															</a>
															<% } %>
													</div>
												</div>
											</td>
										</tr>

										<% if (hasChildren) { %>
											<!-- Дочерние строки -->
											<% displayReferralTable(referal.children, level + 1, referal.referal_id,
												isLastInGroup); %>
												<% } %>
													<% }); } %>

														<% displayReferralTable(referalTree, 1, null); %>
							</tbody>
						</table>
					</div>
				</div>
				<% } else { %>
					<div class="empty-state">
						<div class="empty-icon">
							<i class="fas fa-table"></i>
						</div>
						<h3>Пока нет рефералов</h3>
						<p>Начните приглашать друзей, чтобы построить свою реферальную сеть!</p>
						<button class="btn btn-primary" onclick="copyReferralLink()">
							<i class="fas fa-share"></i>
							Поделиться ссылкой
						</button>
					</div>
					<% } %>
		</section>
	</div>

	<!-- Hidden referral link for copying -->
	<input type="hidden" id="referralLink" value="<%- referal.referral_link_url %>">

	<script src="/js/script.js"></script>
	<script src="/js/table-script.js"></script>
</body>

</html>