# Новый интерфейс реферального дерева

## Обзор

Старый интерфейс реферального дерева был полностью заменен на новый, основанный на предоставленном коде. Новый интерфейс обеспечивает:

- Современный дизайн с градиентными фонами
- Интерактивное древовидное представление данных
- Соединительные линии между узлами
- Статистику в реальном времени
- Адаптивный дизайн для мобильных устройств

## Основные изменения

### 1. Обновленный файл интерфейса
- **Файл**: `src/views/referral-network.ejs`
- **Изменения**: Полностью переписан на основе предоставленного HTML-кода
- **Функциональность**: 
  - Древовидная структура с раскрывающимися узлами
  - Визуальные соединительные линии
  - Статистика в реальном времени
  - Адаптивный дизайн

### 2. Обновленный сервис
- **Файл**: `src/services/referal.service.js`
- **Новый метод**: `getAllReferralsTree()`
- **Функциональность**: Получение всех рефералов в виде дерева для нового интерфейса

### 3. Обновленный контроллер
- **Файл**: `src/controllers/referal.controller.js`
- **Изменения**: Упрощен метод `getAllReferralsTree()` для использования нового сервиса

### 4. Тестовые данные
- **Файл**: `scripts/add-test-referrals.js`
- **Функциональность**: Скрипт для добавления тестовых данных с 4 уровнями вложенности

## Структура данных

Новый интерфейс работает с данными в следующем формате:

```json
{
  "status": true,
  "data": [
    {
      "referal_id": "user001",
      "referer_id": "root001",
      "reg_date": "2025-01-10T00:00:00.000Z",
      "referal_nickname": "john_doe",
      "referer_nickname": "root_user",
      "referal_name": "John Doe",
      "referral_link_url": "https://example.com/ref/user001",
      "personal_channel_link": "https://t.me/john_doe_channel",
      "utm": "source=telegram&campaign=referral",
      "children": [
        {
          "referal_id": "user004",
          "referer_id": "user001",
          // ... остальные поля
          "children": []
        }
      ],
      "totalReferals": 2
    }
  ]
}
```

## API Endpoints

### GET /api/referrals/tree
Возвращает все рефералы в виде дерева.

**Ответ:**
```json
{
  "status": true,
  "data": [/* массив корневых рефералов с детьми */]
}
```

### GET /network
Отображает новый веб-интерфейс реферального дерева.

## Функциональность интерфейса

### 1. Древовидная структура
- Корневые элементы отображаются на верхнем уровне
- Дочерние элементы скрыты по умолчанию
- Клик по кнопке "+" раскрывает дочерние элементы
- Клик по кнопке "−" скрывает дочерние элементы

### 2. Визуальные элементы
- Соединительные линии между родительскими и дочерними узлами
- Горизонтальные линии для каждого дочернего элемента
- Вертикальные линии для раскрытых родительских узлов
- Цветовая индикация статуса (активный/неактивный)

### 3. Статистика
- Общее количество рефералов
- Количество активных рефералов
- Максимальное количество уровней
- Дата последней регистрации

### 4. Адаптивность
- Полностью адаптивный дизайн
- Оптимизация для мобильных устройств
- Масштабируемые элементы интерфейса

## Установка и запуск

### 1. Добавление тестовых данных
```bash
node scripts/add-test-referrals.js
```

### 2. Запуск сервера
```bash
npm start
```

### 3. Доступ к интерфейсу
- Веб-интерфейс: http://localhost:3000/network
- API: http://localhost:3000/api/referrals/tree

## Технические детали

### CSS
- Использование CSS Grid и Flexbox для макета
- CSS переменные для цветовой схемы
- Анимации и переходы для улучшения UX
- Медиа-запросы для адаптивности

### JavaScript
- Vanilla JavaScript (без внешних зависимостей)
- Асинхронная загрузка данных через Fetch API
- Динамическое создание DOM элементов
- Управление состоянием раскрытых/скрытых узлов

### Backend
- Express.js для API
- MongoDB с Mongoose для данных
- Рекурсивное построение дерева рефералов
- Оптимизированные запросы к базе данных

## Совместимость

- Современные браузеры (Chrome, Firefox, Safari, Edge)
- Мобильные браузеры
- Node.js 14+
- MongoDB 4.4+

## Производительность

- Ленивая загрузка дочерних элементов
- Оптимизированные запросы к базе данных
- Минимальное количество DOM операций
- Эффективное управление памятью

## Безопасность

- Валидация входных данных
- Защита от XSS атак
- Безопасные HTTP заголовки
- Валидация на стороне сервера
